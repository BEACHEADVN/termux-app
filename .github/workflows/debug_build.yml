name: Build

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - github-releases/v0.119.0-beta.3
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package_variant: [ apt-android-7 ]

    steps:
      - name: Clone repository
        uses: actions/checkout@v6

      - name: Setup Java 17
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Setup Keystore
        run: |
          if [ -z "${{ secrets.KEYSTORE }}" ]; then
            echo "❌ KEYSTORE secret is EMPTY"
            exit 1
          fi

          echo "${{ secrets.KEYSTORE }}" | base64 -d > key.jks

          {
            echo "KEYSTORE_FILE=key.jks"
            echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}"
            echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}"
            echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}"
          } >> gradle.properties

          echo "✅ Keystore setup done"

      - name: Build and Sign APKs
        shell: bash {0}
        env:
          PACKAGE_VARIANT: ${{ matrix.package_variant }}
        run: |
          set -e

          echo "Setting vars"
          if [ "$GITHUB_EVENT_NAME" == "pull_request" ]; then
              GITHUB_SHA="${{ github.event.pull_request.head.sha }}"
          fi

          CURRENT_VERSION_NAME=$(grep -m1 'versionName' ./app/build.gradle | sed -E 's/.*versionName "([^"]+)".*/\1/')
          RELEASE_VERSION_NAME="v$CURRENT_VERSION_NAME+${GITHUB_SHA:0:7}"
          echo "Release version: $RELEASE_VERSION_NAME"

          APK_DIR="./app/build/outputs/apk/release"

          export TERMUX_APP_VERSION_NAME="${RELEASE_VERSION_NAME/v/}"
          export TERMUX_APK_VERSION_TAG="$RELEASE_VERSION_NAME"
          export TERMUX_PACKAGE_VARIANT="${{ env.PACKAGE_VARIANT }}"

          echo "Building release APKs..."
          ./gradlew assembleRelease

          echo "Signing & renaming APKs..."
          for abi in universal arm64-v8a; do
              SRC="$APK_DIR/app-$abi-release-unsigned.apk"
              DST="$APK_DIR/termux-app_${RELEASE_VERSION_NAME/v/}_$abi.apk"
              if [ -f "$SRC" ]; then
                  jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
                    -keystore key.jks -storepass "${{ secrets.KEYSTORE_PASSWORD }}" \
                    -keypass "${{ secrets.KEY_PASSWORD }}" "$SRC" "${{ secrets.KEY_ALIAS }}"
                  zipalign -v 4 "$SRC" "$DST"
                  echo "✅ Signed $DST"
              else
                  echo "❌ $SRC not found"
                  exit 1
              fi
          done

          echo "Generating sha256sums..."
          (cd "$APK_DIR" && sha256sum termux-app_${RELEASE_VERSION_NAME/v/}_*.apk > termux-app_${RELEASE_VERSION_NAME/v/}_sha256sums)

          echo "APK_DIR=$APK_DIR" >> $GITHUB_ENV
          echo "RELEASE_VERSION_NAME=$RELEASE_VERSION_NAME" >> $GITHUB_ENV

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v6
        with:
          name: termux-app
          path: |
            ${{ env.APK_DIR }}/termux-app_${{ env.RELEASE_VERSION_NAME/v/ }}_universal.apk
            ${{ env.APK_DIR }}/termux-app_${{ env.RELEASE_VERSION_NAME/v/ }}_arm64-v8a.apk
            ${{ env.APK_DIR }}/termux-app_${{ env.RELEASE_VERSION_NAME/v/ }}_sha256sums
